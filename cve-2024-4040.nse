local http = require "http"
local stdnse = require "stdnse"

description = [[
  This script checks if the server is vulnerable to CrushFTP CVE-2024-4040 
  and verifies if a `CrushAuth` cookie is present in the response headers.
]]

author = "Nithen Naidoo"
license = "Same as Nmap - See https://nmap.org/book/man-legal.html"
categories = {"default", "discovery", "auth"}

-- Define the script arguments (optional)
portrule = function(host, port)
  return port.protocol == "tcp" and (port.number == 80 or port.number == 443)
end

-- Main function
action = function(host, port)
  local path = "/WebInterface/"
  local url = string.format("http://%s:%d%s", host.targetname or host.ip, port.number, path)
  
  stdnse.print_debug(1, "Checking for resource: %s", url)
  
  -- Perform the HTTP request
  local response = http.get(host, port, path)
  
  if not response then
    return "Failed to connect to " .. url
  end
  
  -- Check for CrushAuth cookie
  local cookies = response.cookies
  local has_crushauth = false
  for _, cookie in ipairs(cookies) do
    if cookie.name == "CrushAuth" then
      has_crushauth = true
      break
    end
  end
  
  -- Return result based on the presence of the CrushAuth cookie
  if has_crushauth then
    return string.format("Resource %s found and CVE-2024-4040 vulnerability detected.", url)
  else
    return string.format("Resource %s found, but no CVE-2024-4040 vulnerability detected.", url)
  end
end

